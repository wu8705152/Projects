<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>乞丐時光條碼搜尋器</title>
<style>
    .alert-box {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 9999;
        font-size: 16px;
        line-height: 1.4em;
    }
    .alert-info {
        background: rgba(0, 128, 0, 0.85);
    }
</style>
</head>
<body>
    <div>
        <label>品號：</label>
        <input type="text" id="itemNumber" value="">
    </div>
    <div>
        <label>配別：</label>
        <select id="batchCode">
            <option value="1">1</option>
            <option value="3">3</option>
            <option value="6">6</option>
        </select>
    </div>
    <div>
        <label>生產日：</label>
        <input type="date" id="productionDate">
    </div>
    <div>
        <label>到期日：</label>
        <input type="date" id="expiryDate">
    </div>
    <div>
        <label>條碼：</label>
        <span id="barcodeLabel">尚未生成</span>
    </div>

<script>
// 顯示錯誤提示
function showCustomAlert(message) {
    const alertBox = document.createElement("div");
    alertBox.className = "alert-box";
    alertBox.innerHTML = message;
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 3000);
}

// 顯示提示資訊
function show_info_alert(message) {
    const alertBox = document.createElement("div");
    alertBox.className = "alert-box alert-info";
    alertBox.innerHTML = message;
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 3000);
}

// 更新標籤（條碼顯示）
function updateLabel() {
    const itemNumber = document.getElementById('itemNumber').value || "00000000";
    const productionDate = document.getElementById('productionDate').value || "0000-00-00";
    const batchCode = document.getElementById('batchCode').value || "0";
    const expiryDate = document.getElementById('expiryDate').value || "0000-00-00";

    const barcodeText = `${itemNumber} ${productionDate} ${batchCode} ${expiryDate}`;
    document.getElementById('barcodeLabel').innerText = barcodeText;
}

// 條碼解析 + 時段自動配對
function i_time_(scanner_code) {
    const scannedItemNumber = scanner_code.substring(0, 8);
    const scannedbatchCode = scanner_code.substring(11, 12);
    const batchCodeSelect = document.getElementById('batchCode');
    const optionExists = Array.from(batchCodeSelect.options).some(option => option.value === scannedbatchCode);

    if (!scanner_code.startsWith("2")) {
        showCustomAlert(`${scanner_code}無法辨識</br>請重新掃瞄並確認為時控條碼。`);
        document.getElementById('itemNumber').value = "00000000";
        return false;
    } else if (!optionExists) {
        showCustomAlert(`${scanner_code}無法辨識配別</br>請自行選擇配別`);
    }

    document.getElementById('batchCode').value = scannedbatchCode;
    document.getElementById('itemNumber').value = scannedItemNumber;

    const today = new Date();
    const currentHour = today.getHours();
    const futureDate = new Date(today);
    futureDate.setDate(today.getDate() + 1);
    const todayString = today.toISOString().split('T')[0];
    const futureDateString = futureDate.toISOString().split('T')[0];

    switch (scannedbatchCode) {
        case '1': { // 晚上 19~24
            document.getElementById('expiryDate').value = todayString;
            if (currentHour >= 19 && currentHour < 24) {
                show_info_alert(`現在是${currentHour}點</br>自動匹配最近時段配別</br>${todayString} 24前有乞丐時光`);
            } else {
                showCustomAlert(`現在是${currentHour}點</br>非乞丐時光時段19-24 </br> 自動匹配最近時段19點後即有折扣`);
            }
            break;
        }
        case '3':
        case '6': {
            if (currentHour >= 10 && currentHour < 17) { 
                // 白天 10~17 點 -> 批號 6
                document.getElementById('batchCode').value = '6';
                document.getElementById('expiryDate').value = todayString;
                show_info_alert(`現在是${currentHour}點</br>自動匹配最近時段配別</br>${todayString} 17前有乞丐時光`);
            } else if (currentHour >= 19 || currentHour < 3) {
                // 晚上 19~隔天 03 點 -> 批號 3
                document.getElementById('batchCode').value = '3';
                document.getElementById('expiryDate').value = futureDateString;
                show_info_alert(`現在是${currentHour}點</br>自動匹配最近時段配別</br>${futureDateString} 03前有乞丐時光`);
            } else if (currentHour >= 3 && currentHour < 10) {
                // 凌晨 03~10 點 -> 批號 3（當天到期）
                document.getElementById('batchCode').value = '3';
                document.getElementById('expiryDate').value = todayString;
                show_info_alert(`現在是${currentHour}點</br>自動匹配最近時段配別</br>${todayString} 10前有乞丐時光`);
            } else {
                showCustomAlert(`現在是${currentHour}點</br>不在乞丐時光時段，請手動確認。`);
            }
            break;
        }
    }

    updateLabel();
    return true;
}

// 測試用：模擬掃碼
// i_time_("212345672023-09-1832023-09-19");
</script>
</body>
</html>